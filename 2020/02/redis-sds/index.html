<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>SDS | Edison's blog | Java Developer</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="Edison的个人blog"><link rel=prev href=https://Edisonzjs.github.io/2020/01/io-model/><link rel=canonical href=https://Edisonzjs.github.io/2020/02/redis-sds/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="SDS"><meta name=twitter:description content="1.何为SDS redis使用一种名为简单动态字符串(simple dynamic string，简称SDS)的抽象类型，并将SDS用作redis的默认字符串"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"SDS","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/Edisonzjs.github.io\/2020\/02\/redis-sds\/"},"image":{"@type":"ImageObject","url":"https:\/\/Edisonzjs.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"redis","wordcount":2458,"url":"https:\/\/Edisonzjs.github.io\/2020\/02\/redis-sds\/","datePublished":"2020-02-17T14:34:43\x2b08:00","dateModified":"2020-02-17T14:34:43\x2b08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"XXXX","logo":{"@type":"ImageObject","url":"https:\/\/Edisonzjs.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://Edisonzjs.github.io/>Edison's blog | Java Developer</a></div><div class=navbar-menu><a class=menu-item href=https://Edisonzjs.github.io/posts>文章</a>
<a class=menu-item href=https://Edisonzjs.github.io/tags>标签</a>
<a class=menu-item href=https://Edisonzjs.github.io/categories>分类</a>
<a class=menu-item href=https://Edisonzjs.github.io/about>关于</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://Edisonzjs.github.io/>Edison's blog | Java Developer</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://Edisonzjs.github.io/posts>文章</a>
<a class=menu-item href=https://Edisonzjs.github.io/tags>标签</a>
<a class=menu-item href=https://Edisonzjs.github.io/categories>分类</a>
<a class=menu-item href=https://Edisonzjs.github.io/about>关于</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><main class=main><div class=container><article class=post-warp><h1 class="post-title animated flipInX">SDS</h1><div class=post-meta><div class=post-meta-main><a class=author href=https://Edisonzjs.github.io/ rel=author><i class="fas fa-user-circle fa-fw"></i>Edison&nbsp;</a>
<span class=post-category>收录于
<i class="far fa-folder fa-fw"></i><a href=https://Edisonzjs.github.io/categories/redis/>redis</a></span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-02-17>2020-02-17</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>约 2458 字&nbsp;
<i class="far fa-clock fa-fw"></i>预计阅读 5 分钟&nbsp;</div></div><div class=post-toc id=post-toc><h2 class=post-toc-title>目录</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#1何为sds>1.何为SDS</a></li><li><a href=#2sds的好处>2.SDS的好处</a><ul><li><a href=#21-常数复杂度获取字符串长度>2.1 常数复杂度获取字符串长度</a></li><li><a href=#22-杜绝缓冲区溢出>2.2 杜绝缓冲区溢出</a></li><li><a href=#23-减少修改字符串时带来的内存重分配次数>2.3 减少修改字符串时带来的内存重分配次数</a></li><li><a href=#24-二进制安全>2.4 二进制安全</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>目录</span><span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><a href=#1何为sds>1.何为SDS</a></li><li><a href=#2sds的好处>2.SDS的好处</a><ul><li><a href=#21-常数复杂度获取字符串长度>2.1 常数复杂度获取字符串长度</a></li><li><a href=#22-杜绝缓冲区溢出>2.2 杜绝缓冲区溢出</a></li><li><a href=#23-减少修改字符串时带来的内存重分配次数>2.3 减少修改字符串时带来的内存重分配次数</a></li><li><a href=#24-二进制安全>2.4 二进制安全</a></li></ul></li></ul></nav></div></details></div><div class=post-content><a class=post-dummy-target id=1何为sds></a><h2>1.何为SDS</h2><p>redis使用一种名为简单动态字符串(simple dynamic string，简称SDS)的抽象类型，并将SDS用作redis的默认字符串表示。</p><p>在redis中，C字符串只会作为字符串字面量用在一些无需对字符串值进行修改的地方，例如打印日志。当redis需要的不仅仅是一个字符串字面量，而是一个可以修改的字符串值时，redis就会使用SDS来表示字符串值。</p><p>举个栗子，在客户端执行命令：<code>set msg "hello world"</code></p><p>那么redis将创建一个新的键值对，其中：</p><ul><li><code>键值对的键是一个字符串对象，对象的底层实现是一个保存着字符串“msg"的SDS。</code></li><li><code>键值对的值也是一个字符串对象，对象底层实现是一个保持着字符串“hello world"的SDS。</code></li></ul><p>又例如，在客户端执行：<code>rpush fruits "apple" "banana" "cherry"</code></p><p>那么redis将创建一个新的键值对，其中：</p><ul><li><code>键值对的键是一个字符串对象，对象的底层实现是一个保存着字符串"fruits"的SDS。</code></li><li><code>键值对的值是一个列表对象，包含了3个SDS实现的字符串对象，第一个"apple"，第二个"banana"，第三个“cheery”。</code></li></ul><p>每个sds.h/sdshdr结构表示一个SDS</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=n>struct</span> <span class=n>sdshdr</span> <span class=o>{</span>
    <span class=c1>// 记录buf数组中已使用的字节数，等于SDS所保存的字符串长度
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>len</span><span class=o>;</span>
    <span class=c1>// 记录buf数组中未使用的字节数量
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>free</span><span class=o>;</span>
    <span class=c1>// 字节数组，用于保存字符串
</span><span class=c1></span>    <span class=kt>char</span> <span class=n>buf</span><span class=o>[</span><span class=o>]</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p><img src=https://i.loli.net/2020/02/17/3RFdXhWkQLHf15l.png alt=image.png></p><p>上图是一个sds的结构，它表示一个字符串"Redis&rdquo;。其中free=0，代表这个SDS没有任何未使用空间，len=5表示这个SDS保存了一个5字节长度的字符串。buf是一个char类型的数组，数组的最后一个字节保存了空字符&rsquo;\0&rsquo;。SDS遵循C字符串以空字符结尾的惯例，但保存空字符的1字节空间不计算在SDS的len属性里。SDS遵循这一惯例是为了直接重用一部分C字符串函数库的函数。</p><a class=post-dummy-target id=2sds的好处></a><h2>2.SDS的好处</h2><a class=post-dummy-target id=21-常数复杂度获取字符串长度></a><h3>2.1 常数复杂度获取字符串长度</h3><p>像C这样直接使用字节数组来保存字符串，获取字符串长度时要依次遍历每个字符直到遇到空字符为止，这个操作的时间复杂度为0(N)。</p><p>而对于SDS来说，直接获取len属性就可以了。时间复杂度为O(1)。</p><a class=post-dummy-target id=22-杜绝缓冲区溢出></a><h3>2.2 杜绝缓冲区溢出</h3><p>C字符串不记录自身长度，可能会造成缓冲区溢出。比如这个函数：<code>char *stract(char *dest, const char *src)</code>，将src拼接到dest的末尾。stract会假设用户已经为dest分配了足够多的内存，而一旦这个假设不成立，就会产生缓冲区溢出。</p><p>而SDS完全杜绝了这种可能，当对SDS修改时，SDS会先检查空间是否满足需要，如果空间不够，SDS会自动将空间扩展至执行修改所需的大小，然后才执行修改操作。</p><p><img src=https://i.loli.net/2020/02/17/3RFdXhWkQLHf15l.png alt=image.png></p><p>例如我们对上图的SDS执行函数：<code>sdcat(s," Clustser")</code>。s为SDS的值。</p><p>那么sdscat在执行拼接操作前，会先检查s的长度是否足够，在发现s目前的空间不足以拼接&rdquo;  Cluster"后，sdcat就会先扩展s的空间，然后再执行&rdquo;  Cluster"的拼接操作。</p><p><img src=https://i.loli.net/2020/02/17/wtmn1fRjsgz3HqG.png alt=image.png></p><p>注意，sdscat不仅执行了拼接操作，还未SDS分配了13字节的未使用空间。这可不是巧合，而是一种策略。下面来说明这种策略的好处</p><a class=post-dummy-target id=23-减少修改字符串时带来的内存重分配次数></a><h3>2.3 减少修改字符串时带来的内存重分配次数</h3><p>在对C字符串做修改时，如果追加字符则需要通过内存重分配来拓展内存空间，如果截取字符则需要通过内存重分配来释放内存。但是对于redis这种要求速度快，数据频繁修改的场合，如果每次修改都要一次内存重分配，那么对性能带来损耗是不能接受的。</p><p>为了避免这种缺陷，SDS通过空间预分配和惰性空间释放两种策略来优化。</p><p>空间预分配：当对SDS的字符串做增长操作，并且需要对SDS进行空间预分配时，程序不仅会为SDS分配修改所必要的空间，还会为SDS分配额外的未使用空间。</p><ul><li><p>如果SDS的len属性小于1MB，那么将分配和len属性同样大小的未使用空间，这时SDS的len属性值和free属性值相同。举个例子，如果修改后SDS的len变成13字节，那么程序也会分配13字节的未使用空间，那么SDS的buf数组实际长度将变成<code>13+13+1=27字节(额外的一字节用于保存空字符)</code>。</p></li><li><p>如果SDS的len属性大于1MB。那么程序将分配1MB的未使用空间。例如，修改后，SDS的len变成2MB，那么程序会分配1MB的未使用空间，SDS的buf数组实际长度将变成<code>2MB+1MB+1byte</code></p></li></ul><p>通过空间预分配策略，redis可以减少连续执行字符串增长操作所需的内存分配次数</p><p><img src=https://i.loli.net/2020/02/17/3RFdXhWkQLHf15l.png alt=image.png></p><p>例如我们对上面的SDS执行：<code>sdcat(s," Clustser")</code>；那么sdcat将执行一次内存重分配操作，将SDS长度修改为13字节，并将SDS的未使用空间同样修改为13字节，如下图所示。</p><p><img src=https://i.loli.net/2020/02/17/wtmn1fRjsgz3HqG.png alt=image.png></p><p>如果这时，我们再次执行：<code>sdcat(s," Tutorial")</code>；那么这次sdscat将不需要执行内存重分配，因为未使用空间的13字节足以保存9字节的“  Tutorial”，执行后SDS如下图所示</p><p><img src=https://i.loli.net/2020/02/17/ft7EYksBoH2aj9Q.png alt=image.png></p><p>惰性空间释放：当对SDS字符串做缩短操作时，程序并不会立即使用内存重分配来回收缩短后多余的字节空间。而是用free属性将这些字节记录下来，供后续使用。</p><p>我们也不必担心惰性空间释放策略会造成内存浪费，SDS提供了相应的API，让我们可以在有需要时释放SDS的未使用空间。</p><a class=post-dummy-target id=24-二进制安全></a><h3>2.4 二进制安全</h3><p>C字符串中要求除了以空字符结尾，字符串中不能含有空字符。否则最先被读入的空字符会被误以为是字符串的结尾。这些限制使得C字符串只能保存文本数据，而不能保存图片、音频、视频、压缩文件这样的二进制数据。为了确保redis可以适用于各种不同的使用场景，SDS的API都是二进制安全的，所有SDS API都会以处理二进制的方式来处理SDS存放在buf数组里的数据。</p><p>所以我们称SDS的buf属性为字节数组，因为它不是来保存字符，而是保存一系列二进制数据。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>本文于 2020-02-17 更新</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href="//twitter.com/share?url=https%3a%2f%2fEdisonzjs.github.io%2f2020%2f02%2fredis-sds%2f&text=SDS&via=EdisonZjs" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fEdisonzjs.github.io%2f2020%2f02%2fredis-sds%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://Edisonzjs.github.io/tags/redis/><i class="fas fa-tag fa-fw"></i>redis</a></span></section><section><span><a href=javascript:window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=https://Edisonzjs.github.io/>主页</a></span></section></div><div class=post-nav><a href=https://Edisonzjs.github.io/2020/01/io-model/ class=prev rel=prev title=五种IO模型><i class="fas fa-angle-left fa-fw"></i>五种IO模型</a></div></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://Edisonzjs.github.io/>Edison</a></span><span class=license>&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer><script src=/js/lib/jquery/jquery.slim.min.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a></body></html>